# 作业7

## 李毅PB22051031

#### 4.30

##### 4.30.1

执行阶段目标地址无效

访存阶段访存地址无效

##### 4.30.2

增加例外检测，给PC多选器新增一个输入，保证能将例外入口地址送给PC寄存器。同时将已经在流水线的指令替换为NOP

##### 4.30.3

第一条指令取指正常执行，直到第一条指令的例外发生。此时会将已经在流水线的指令替换为NOP，即第二条指令被替换为NOP，永远不会执行。在检测到例外的周期之后的周期中，处理器将获取例外处理程序的第一条指令。

##### 4.30.4

用基址寄存器加上例外原因（偏移）作为目标地址来完成控制流转换，基址寄存器中保存了向量式中断内存区域的起始地址。操作系统根据例外向量起始地址来确定例外原因。

##### 4.30.5

我们需要一种特殊指令，首先保存通用寄存器（以便稍后恢复它），将异常情况地址加载到其中，将向量表的偏移添加到其中，使用结果作为从异常处理程序地址的地址进行加载，并跳转到该处理程序。

#### 5.5

##### 5.5.1

偏移为5位，即单个数据块大小为2^5=32字节，64位机一个字为8字节，所以一个数据块大小为4个字。

##### 5.5.2

5位索引即有2^5=32个数据块

##### 5.5.3

总位数为
$$
32 \times(4\times64+54+1)=9952
$$
数据存储位数为
$$
32 \times(4\times64)=8192
$$
比率为8192/9952=0.823

##### 5.5.4

| 地址 | 二进制地址（低12位） | 标签(低2位，高位全为0) | 索引   | 偏移   | 命中/失效 | 替换字节（16进制） |
| ---- | -------------------- | ---------------------- | ------ | ------ | --------- | ------------------ |
| 00   | 0000 0000 0000       | 00                     | 00 000 | 0 0000 | 失效      |                    |
| 04   | 0000 0000 0100       | 00                     | 00 000 | 0 0100 | 命中      |                    |
| 10   | 0000 0001 0000       | 00                     | 00 000 | 1 0000 | 命中      |                    |
| 84   | 0000 1000 0100       | 00                     | 00 100 | 0 0100 | 失效      |                    |
| E8   | 0000 1111 1000       | 00                     | 00 111 | 1 1000 | 失效      |                    |
| A0   | 0000 1010 0000       | 00                     | 00 101 | 0 0000 | 失效      |                    |
| 400  | 0100 0000 0000       | 01                     | 00 000 | 0 0000 | 失效      | 0x00-0x1f          |
| 1E   | 0000 0001 1111       | 00                     | 00 000 | 1 1111 | 失效      | 0x400-0x41f        |
| 8C   | 0000 1000 1100       | 00                     | 00 100 | 0 1100 | 命中      |                    |
| C1C  | 1100 0001 1100       | 11                     | 00 000 | 1 1100 | 失效      | 0x00-0x1f          |
| B4   | 0000 1011 0100       | 00                     | 00 101 | 1 0100 | 命中      |                    |
| 884  | 1000 1000 0100       | 10                     | 00 100 | 0 0100 | 失效      | 0x80-0x9f          |

##### 5.5.5

命中率为4/12=33.3%

##### 5.5.6

<标签，索引，数据>

<  11，  00 000，MEM（0xC00-0xC1F）>

<  10，  00 100，MEM（0x880-0x89F）>

<  00，  00 101，MEM（0xA0-0xBF）>

<  00，  00 111，MEM（0xE0-0xFF）>



#### 5.11

##### 5.11.1

##### ![image-20240513175401685](C:\Users\Liyi\AppData\Roaming\Typora\typora-user-images\image-20240513175401685.png)

##### 5.11.2

| 地址 | 二进制地址 | 标签    | 索引   | 偏移 | 命中/失效 | 路1                                | 路2            | 路3    |
| ---- | ---------- | ------- | ------ | ---- | --------- | ---------------------------------- | -------------- | ------ |
| 0x03 | 0000 0011  | 0000(0) | 001(1) | 1    | 失效      | T(1)=0                             |                |        |
| 0xb4 | 1011 0100  | 1011(b) | 010(2) | 0    | 失效      | T(1)=0,T(2)=b                      |                |        |
| 0x2b | 0010 1011  | 0010(2) | 101(5) | 1    | 失效      | T(1)=0,T(2)=b,T(5)=2               |                |        |
| 0x02 | 0000 0010  | 0000(0) | 001(1) | 0    | 命中      | T(1)=0,T(2)=b,T(5)=2               |                |        |
| 0xbe | 1011 1110  | 1011(b) | 111(7) | 0    | 失效      | T(1)=0,T(2)=b,T(5)=2,T(7)=b        |                |        |
| 0x58 | 0101 1000  | 0101(5) | 100(4) | 0    | 失效      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b |                |        |
| 0xbf | 1011 1111  | 1011(b) | 111(7) | 1    | 命中      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b |                |        |
| 0x0e | 0000 1110  | 0000(0) | 111(7) | 0    | 失效      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b | T(7)=0         |        |
| 0x1f | 0001 1111  | 0001(1) | 111(7) | 1    | 失效      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b | T(7)=0         | T(7)=1 |
| 0xb5 | 1011 0101  | 1011(b) | 010(2) | 1    | 命中      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b | T(7)=0         | T(7)=1 |
| 0xbf | 1011 1111  | 1011(b) | 111(7) | 1    | 命中      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b | T(7)=0         | T(7)=1 |
| 0xba | 1011 1010  | 1011(b) | 101(5) | 0    | 失效      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b | T(5)=b, T(7)=0 | T(7)=1 |
| 0x2e | 0010 1110  | 0010(2) | 111(7) | 0    | 失效      | T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b | T(5)=b, T(7)=2 | T(7)=1 |
| 0xce | 1100 1110  | 1100(c) | 111(7) | 0    | 失效      |                T(1)=0,T(2)=b,T(4)=5,T(5)=2,T(7)=b                   |     T(5)=b, T(7)=2         |    T(7)=c    |



##### 5.11.3

![image-20240513180123645](C:\Users\Liyi\AppData\Roaming\Typora\typora-user-images\image-20240513180123645.png)

##### 5.11.4

| 地址 | 二进制地址 | 标签 | 命中/失效 | 内容                    |
| ---- | ---------- | ---- | --------- | ----------------------- |
| 0x03 | 0000  0011 | 0x03 | 失效      | 03,                     |
| 0xb4 | 1011  0100 | 0xb4 | 失效      | 03,b4                   |
| 0x2b | 0010  1011 | 0x2b | 失效      | 03,b4,2b                |
| 0x02 | 0000  0010 | 0x02 | 失效      | 03,b4,2b,02             |
| 0xbe | 1011  1110 | 0xbe | 失效      | 03,b4,2b,02,be          |
| 0x58 | 0101  1000 | 0x58 | 失效      | 03,b4,2b,02,be,58       |
| 0xbf | 1011  1111 | 0xbf | 失效      | 03,b4,2b,02,be,58,bf    |
| 0x0e | 0000  1110 | 0x0e | 失效      | 03,b4,2b,02,be,58,bf,0e |
| 0x1f | 0001  1111 | 0x1f | 失效      | 1f,b4,2b,02,be,58,bf,0e |
| 0xb5 | 1011  0101 | 0xb5 | 失效      | 1f,b5,2b,02,be,58,bf,0e |
| 0xbf | 1011  1111 | 0xbf | 命中      | 1f,b5,2b,02,be,58,bf,0e |
| 0xba | 1011  1010 | 0xba | 失效      | 1f,b5,ba,02,be,58,bf,0e |
| 0x2e | 0010  1110 | 0x2e | 失效      | 1f,b5,ba,2e,be,58,bf,0e |
| 0xce | 1100  1110 | 0xce | 失效      | 1f,b5,ba,2e,ce,58,bf,0e |

##### 5.11.5

![image-20240513180143438](C:\Users\Liyi\AppData\Roaming\Typora\typora-user-images\image-20240513180143438.png)

##### 5.11.6

| 地址 | 二进制地址 | 标签 | 偏移 | 命中/失效 | 内容(标签值)         |
| ---- | ---------- | ---- | ---- | --------- | -------------------- |
| 0x03 | 0000  0011 | 0x01 | 1    | 失效      | 0x01                 |
| 0xb4 | 1011  0100 | 0x5a | 0    | 失效      | 0x01,0x5a            |
| 0x2b | 0010  1011 | 0x15 | 1    | 失效      | 0x01,0x5a,0x15       |
| 0x02 | 0000  0010 | 0x01 | 0    | 命中      | 0x5a,0x15,0x01       |
| 0xbe | 1011  1110 | 0x5f | 0    | 失效      | 0x5a,0x15,0x01,0x5f  |
| 0x58 | 0101  1000 | 0x2c | 0    | 失效      | 0x15,0x01,0x5f,0x2c  |
| 0xbf | 1011  1111 | 0x5f | 1    | 命中      | 0x15,0x01,0x2c,,0x5f |
| 0x0e | 0000  1110 | 0x07 | 0    | 失效      | 0x01,0x2c,0x5f,0x07  |
| 0x1f | 0001  1111 | 0x0f | 1    | 失效      | 0x2c,0x5f,0x07,0x0f  |
| 0xb5 | 1011  0101 | 0x5a | 1    | 失效      | 0x5f,0x07,0x0f,0x5a  |
| 0xbf | 1011  1111 | 0x5f | 1    | 命中      | 0x07,0x0f,0x5a,0x5f  |
| 0xba | 1011  1010 | 0x5d | 0    | 失效      | 0x0f,0x5a,0x5f,0x5d  |
| 0x2e | 0010  1110 | 0x17 | 0    | 失效      | 0x5a,0x5f,0x5d,0x17  |
| 0xce | 1100  1110 | 0x67 | 0    | 失效      | 0x5f,0x5d,0x17,0x67  |

##### 5.11.7

| 地址 | 二进制地址 | 标签 | 偏移 | 命中/失效 | 内容(标签值)        |
| ---- | ---------- | ---- | ---- | --------- | ------------------- |
| 0x03 | 0000  0011 | 0x01 | 1    | 失效      | 0x01                |
| 0xb4 | 1011  0100 | 0x5a | 0    | 失效      | 0x01,0x5a           |
| 0x2b | 0010  1011 | 0x15 | 1    | 失效      | 0x01,0x5a,0x15      |
| 0x02 | 0000  0010 | 0x01 | 0    | 命中      | 0x5a,0x15,0x01      |
| 0xbe | 1011  1110 | 0x5f | 0    | 失效      | 0x5a,0x15,0x01,0x5f |
| 0x58 | 0101  1000 | 0x2c | 0    | 失效      | 0x5a,0x15,0x01,0x2c |
| 0xbf | 1011  1111 | 0x5f | 1    | 失效      | 0x5a,0x15,0x01,0x5f |
| 0x0e | 0000  1110 | 0x07 | 0    | 失效      | 0x5a,0x15,0x01,0x07 |
| 0x1f | 0001  1111 | 0x0f | 1    | 失效      | 0x5a,0x15,0x01,0x0f |
| 0xb5 | 1011  0101 | 0x5a | 1    | 命中      | 0x15,0x01,0x0f,0x5a |
| 0xbf | 1011  1111 | 0x5f | 1    | 失效      | 0x15,0x01,0x0f,0x5f |
| 0xba | 1011  1010 | 0x5d | 0    | 失效      | 0x15,0x01,0x0f,0x5d |
| 0x2e | 0010  1110 | 0x17 | 0    | 失效      | 0x15,0x01,0x0f,0x17 |
| 0xce | 1100  1110 | 0x67 | 0    | 失效      | 0x15,0x01,0x0f,0x67 |

##### 5.11.8

| 地址 | 二进制地址 | 标签 | 偏移 | 命中/失效 | 内容(标签值)        |
| ---- | ---------- | ---- | ---- | --------- | ------------------- |
| 0x03 | 0000  0011 | 0x01 | 1    | 失效      | 0x01                |
| 0xb4 | 1011  0100 | 0x5a | 0    | 失效      | 0x01,0x5a           |
| 0x2b | 0010  1011 | 0x15 | 1    | 失效      | 0x01,0x5a,0x15      |
| 0x02 | 0000  0010 | 0x01 | 0    | 命中      | 0x01,0x5a,0x15      |
| 0xbe | 1011  1110 | 0x5f | 0    | 失效      | 0x01,0x5a,0x15,0x5f |
| 0x58 | 0101  1000 | 0x2c | 0    | 失效      | 0x2c,0x5a,0x15,0x5f |
| 0xbf | 1011  1111 | 0x5f | 1    | 命中      | 0x2c,0x5a,0x15,0x5f |
| 0x0e | 0000  1110 | 0x07 | 0    | 失效      | 0x07,0x5a,0x15,0x5f |
| 0x1f | 0001  1111 | 0x0f | 1    | 失效      | 0x0f,0x5a,0x15,0x5f |
| 0xb5 | 1011  0101 | 0x5a | 1    | 命中      | 0x0f,0x5a,0x15,0x5f |
| 0xbf | 1011  1111 | 0x5f | 1    | 命中      | 0x0f,0x5a,0x15,0x5f |
| 0xba | 1011  1010 | 0x5d | 0    | 失效      | 0x0f,0x5a,0x5d,0x5f |
| 0x2e | 0010  1110 | 0x17 | 0    | 失效      | 0x0f,0x5a,0x17,0x5f |
| 0xce | 1100  1110 | 0x67 | 0    | 失效      | 0x0f,0x5a,0x67,0x5f |

#### 5.24

##### 5.24.1

能够满足请求，因为当写缓冲区写回内存时，cache处于空闲状态。

##### 5.24.2

cache必须等到写回完成才能更新，因为内存通道被占用

##### 5.24.3

内存读取应该在内存写入之前进行。在完成写入之前，对于cache失效请求，cache不应该更新。而对于cache命中请求可以正常工作。



#### 思考题

##### 1.中断周期要完成哪些微操作

中断请求,中断响应,保存现场,中断服务例程,中断处理,恢复现场,中断返回

##### 2.多周期状态机中，出现溢出的指令是否将错误结果写回

不会写回。可以添加溢出标志设置为指示溢出已发生，但不将错误结果写回。后续指令可以检测到溢出标志并相应地调整其行为。避免将错误结果传播到系统的其他部分。

##### 3.流水线是否存在“中断周期”？

流水线没有显式“中断周期”，因为中断通常会中断当前正在执行的指令流，并导致流水线的停顿。当发生中断时，处理器会暂停当前流水线中的指令，然后转移到中断处理程序所在的地址。这种转移可能需要几个时钟周期来完成。
